<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Summary</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/tryout.css">
    <script src="https://cdn.jsdelivr.net/npm/clipper-lib@6.4.2/clipper.min.js"></script>
</head>
<body>
    <header class="sticky-header">
        <div class="header-content">
            <h1 class="page-title">ROUTINE MAPPING</h1>
        </div>
    </header>
    <div class="container tryout-container"">
        <!-- Main Content -->
        <main class="form-content">
            <div class="form-header">
                <p class="form-description">
                    This is the starting point of your intake configuration. You'll answer 9 questions, each shaping a
                    specific part of your intake pattern. Your responses will be used to build a visual and functional
                    structure that reflects your eating habits.
                </p>
            </div>

        </main>
    </div>

    <!-- Background Section Container - Full Width -->
    <div class="background-section-fullwidth">
        <div class="background-content-container" style="padding-left: 10vw;">
            <!-- User Identification Section -->
            <div class="identification-section">
                <h2 class="section-title">USER IDENTIFICATION</h2>
                <div class="user-details" id="user-details">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Pattern and Preferences Section -->
            <div class="pattern-section">
                <div class="pattern-column">
                    <div class="pattern-visual">
                        <div id="generated-pattern" class="generated-pattern">
                            <canvas id="offset-canvas"></canvas>
                        </div>
                    </div>
                    
                    <div class="input-index" style="display:none">
                        <p><strong>Input Index:</strong></p>
                        <p id="input-index-values"><!-- Will be populated --></p>
                    </div>
                </div>
                
                <div class="preferences-summary">
                    <h3 class="preferences-title">PREFERENCES</h3>
                    <div class="preference-items" id="preference-items">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container tryout-container">
        <main class="form-content">
        </main>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="logo">
                <img src="assets/logo.svg" alt="INTK72 Logo" class="logo-icon">
            </div>
            <p class="footer-text">
              Developed during stable conditions, this system pre-defines meal timing, structure, and nutritional balance to ensure continuity when access is limited, disrupted, or uncertain. Preserving routine and reducing stress through pre-established logic. Established 2025.
            </p>
        </div>
    </footer>

 <style>
        /* Background Section - Full Width */
        .background-section-fullwidth {
            background-color: rgba(241, 241, 241, 1);
            width: 100vw;
            margin-left: calc(-50vw + 50%);
            padding: 4vh 0;
        }

        .background-content-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 4vw;
        }

        /* Results Page Styles */
        .results-content {
            padding-top: 4vh;
            padding-bottom: 4vh;
        }

        .results-title {
            font-family: 'FormaTextTest', 'Inter', sans-serif;
            font-size: clamp(2rem, 4vw, 3rem);
            font-weight: 600;
            text-transform: uppercase;
            
            line-height: 1.1;
            margin: 0 0 4vh 0;
            border-bottom: 3px solid black;
            padding-bottom: 0.1em;
            display: inline-block;
        }

        .section-title {
            font-family: 'FormaTextTest', 'Inter', sans-serif;
            font-size: clamp(1.2rem, 2.4vw, 1.6rem);
            font-weight: 600;
            text-transform: uppercase;
            
            margin: 0 0 2vh 0;
        }

        .identification-section {
            margin-bottom: 4vh;
        }

        .user-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1vh 4vw;
            font-family: 'Inter', sans-serif;
            font-size: clamp(1rem, 2vw, 1.25rem);
            font-weight: 600;
        }

        .pattern-section {
            display: flex;
            gap: 4vw;
            margin-bottom: 4vh;
            align-items: flex-start;
        }

        .pattern-column {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        .pattern-visual {
            width: 300px;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #e0e0e0;
            background-color: white;
            margin-bottom: 3vh;
        }

        .generated-pattern {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #offset-canvas {
            max-width: 100%;
            max-height: 100%;
            display: block;
        }

        .input-index {
            font-family: 'Inter', sans-serif;
            font-size: clamp(0.9rem, 1.8vw, 1.1rem);
            font-weight: 600;
            max-width: 300px;
        }

        .input-index p {
            margin: 0.5vh 0;
        }

        .preferences-summary {
            flex: 1;
        }

        .preferences-title {
            font-family: 'FormaTextTest', 'Inter', sans-serif;
            font-size: clamp(1.2rem, 2.4vw, 1.6rem);
            font-weight: 600;
            text-transform: uppercase;
            
            margin: 0 0 2vh 0;
        }

        .preference-items {
            margin-bottom: 3vh;
        }

        .preference-item {
            font-family: 'Inter', sans-serif;
            font-size: clamp(1rem, 2vw, 1.25rem);
            font-weight: 600;
            margin-bottom: 1vh;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .background-content-container {
                padding: 0 3vw;
            }
            
            .pattern-section {
                flex-direction: column;
                gap: 3vh;
            }
            
            .pattern-column {
                align-self: center;
            }
            
            .pattern-visual {
                width: 250px;
                height: 250px;
            }
            
            .input-index {
                max-width: 250px;
                text-align: center;
            }
            
            .user-details {
                grid-template-columns: 1fr;
                gap: 1vh;
            }
        }
    </style>


    <script>
        // Initialization
        function initializeUserData() {
            let userData = sessionStorage.getItem('intk72UserData');
            if (!userData) {
                userData = {
                    identification: {},
                    consumptionLimits: { dietary: [], allergies: [] },
                    answers: {}
                };
            } else {
                userData = JSON.parse(userData);
            }
            window.intk72UserData = userData;
            return userData;
        }

        // User Details
        function calculateAge(year, month, day) {
            if (!year || !month || !day) return null;
            const birthDate = new Date(year, month - 1, day);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
            return age;
        }

        function formatDate(day, month, year) {
            if (!day || !month || !year) return 'Not provided';
            return `${String(day).padStart(2,'0')}/${String(month).padStart(2,'0')}/${year}`;
        }

        function populateUserDetails() {
            const data = window.intk72UserData.identification;
            const age = calculateAge(data.birthYear, data.birthMonth, data.birthDay);
            const fullName = [data.firstName, data.lastName].filter(Boolean).join(' ');
            document.getElementById('user-details').innerHTML = `
                <div><strong>Full Name:</strong> ${fullName || 'Not provided'}</div>
                <div><strong>Age:</strong> ${age || 'Not provided'}</div>
                <div><strong>Date of Birth:</strong> ${formatDate(data.birthDay, data.birthMonth, data.birthYear)}</div>
                <div><strong>Gender:</strong> ${data.gender ? data.gender.charAt(0).toUpperCase()+data.gender.slice(1) : 'Not provided'}</div>
                <div><strong>Origin:</strong> ${data.origin || 'Not provided'}</div>
            `;
        }

        // Updated Preferences Logic
        function generatePreferencesSummary() {
            const ans = window.intk72UserData.answers;
            const userData = window.intk72UserData.identification;
            
            // Lifestyle: Healthy, Standard, Snacker
            let lifestyle = 'Standard';
            if (ans.q1?.answer === '1') lifestyle = 'Healthy';
            else if (ans.q1?.answer === '3') lifestyle = 'Snacker';
            
            // Meal: Routine, Random, Flexible
            let meal = 'Flexible';
            if (ans.q6?.answer === '1') meal = 'Routine';
            else if (ans.q6?.answer === '4') meal = 'Random';
            
            // Flavor: Homestyle, Junk, Mixed
            let flavor = 'Mixed';
            if (ans.q9?.answer === '1') flavor = 'Homestyle';
            else if (ans.q9?.answer === '2') flavor = 'Junk';
            
            // Priority Status based on age
            let priority = 'Standard';
            const age = calculateAge(userData.birthYear, userData.birthMonth, userData.birthDay);
            if (age !== null) {
                if (age >= 65) priority = 'Elderly';
                else if (age >= 3 && age <= 14) priority = 'Child';
                else priority = 'Standard';
            }
            
            document.getElementById('preference-items').innerHTML = `
                <div class="preference-item"><strong>Lifestyle:</strong> ${lifestyle}</div>
                <div class="preference-item"><strong>Meal:</strong> ${meal}</div>
                <div class="preference-item"><strong>Flavor:</strong> ${flavor}</div>
                <div class="preference-item"><strong>Priority Status:</strong> ${priority}</div>
            `;
        }

        // Input Index
        function generateInputIndex() {
            const ans = window.intk72UserData.answers;
            let idxStr='';
            for(let i=1;i<=9;i++) {
                const a = ans[`q${i}`];
                idxStr += `${i}.${a?.answer||0} `;
            }
            document.getElementById('input-index-values').textContent = idxStr.trim();
        }

        // Pattern Offset Workflow
        const GRID=3,CELL=120,MM_TO_PX=3.78,OFFSET_MM=3,SF=200;
        const DELTA=Math.round(OFFSET_MM*MM_TO_PX*SF),CANVAS_MARGIN=OFFSET_MM*MM_TO_PX+10;
        const SAMPLE_STEP_PX=1,ARC_TOLERANCE=0.25,MITER_LIMIT=1000;
        let originalShapes=[],offsetPolys=[],outerPoly=[];
        const canvas=document.getElementById('offset-canvas');
        const ctx=canvas.getContext('2d');
        function resetCanvas(){const sz=GRID*CELL+CANVAS_MARGIN*2;canvas.width=sz;canvas.height=sz;ctx.setTransform(1,0,0,1,CANVAS_MARGIN,CANVAS_MARGIN);}
        function clearCanvas(){ctx.clearRect(-CANVAS_MARGIN,-CANVAS_MARGIN,canvas.width,canvas.height);}        
        function drawGrid(){ctx.save();ctx.strokeStyle='#ddd';ctx.lineWidth=1;for(let i=0;i<=GRID;i++){const p=i*CELL;ctx.beginPath();ctx.moveTo(p,0);ctx.lineTo(p,GRID*CELL);ctx.stroke();ctx.beginPath();ctx.moveTo(0,p);ctx.lineTo(GRID*CELL,p);ctx.stroke();}ctx.restore();}
        function drawPolys(polys,opts={}){const{s='#000',lw=1}=opts;ctx.beginPath();polys.forEach(poly=>{poly.forEach((pt,i)=>{const x=pt.X/SF,y=pt.Y/SF;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});ctx.closePath();});ctx.strokeStyle=opts.strokeStyle||s;ctx.lineWidth=opts.lineWidth||lw;ctx.stroke();}
        async function getPolygons(){const shapes=[];const ans=window.intk72UserData.answers||{};for(const[q,{shape}]of Object.entries(ans)){if(!shape)continue;const idx=parseInt(q.slice(1))-1,ox=(idx%GRID)*CELL,oy=Math.floor(idx/GRID)*CELL;const svg=await fetch(`assets/shapes/${shape}.svg`).then(r=>r.text());const doc=new DOMParser().parseFromString(svg,'image/svg+xml');const[vx,vy,vw,vh]=doc.querySelector('svg').getAttribute('viewBox').split(' ').map(Number);const sx=CELL/vw,sy=CELL/vh;doc.querySelectorAll('path').forEach(path=>{const pts=[];const len=path.getTotalLength();for(let d=0;d<=len;d+=SAMPLE_STEP_PX){const p=path.getPointAtLength(d);pts.push({X:Math.round(((p.x-vx)*sx+ox)*SF),Y:Math.round(((p.y-vy)*sy+oy)*SF)});}let curved=false;if(path.getPathData)path.getPathData().forEach(c=>{if(['C','Q','A'].includes(c.type))curved=true;});shapes.push({pts,isCurved:curved});});}return shapes;}
        function computeOffset(poly,curved){const co=new ClipperLib.ClipperOffset(ARC_TOLERANCE,MITER_LIMIT);co.AddPath(poly,curved?ClipperLib.JoinType.jtRound:ClipperLib.JoinType.jtMiter,ClipperLib.EndType.etClosedPolygon);const out=new ClipperLib.Paths();co.Execute(out,DELTA);return out;}
        function computeUnion(ps){const c=new ClipperLib.Clipper();ps.forEach(p=>c.AddPath(p,ClipperLib.PolyType.ptSubject,true));const o=new ClipperLib.Paths();c.Execute(ClipperLib.ClipType.ctUnion,o,ClipperLib.PolyFillType.pftNonZero,ClipperLib.PolyFillType.pftNonZero);return o;}
        function keepLargest(ps){if(!ps.length)return[];return[ps.reduce((b,c)=>Math.abs(ClipperLib.Clipper.Area(c))>Math.abs(ClipperLib.Clipper.Area(b))?c:b,ps[0])];}
        async function runWorkflow(){resetCanvas();clearCanvas();drawGrid();originalShapes=await getPolygons();drawPolys(originalShapes.map(s=>s.pts));await new Promise(r=>setTimeout(r,500));clearCanvas();drawPolys(originalShapes.map(s=>s.pts));offsetPolys=[];originalShapes.forEach(s=>offsetPolys.push(...computeOffset(s.pts,s.isCurved)));drawPolys(offsetPolys,{strokeStyle:'#f00'});await new Promise(r=>setTimeout(r,500));clearCanvas();drawPolys(offsetPolys,{strokeStyle:'#f00'});await new Promise(r=>setTimeout(r,500));outerPoly=keepLargest(computeUnion(offsetPolys));clearCanvas();drawPolys(outerPoly);await new Promise(r=>setTimeout(r,500));clearCanvas();drawPolys(outerPoly,{lineWidth:6});}
        document.addEventListener('DOMContentLoaded',()=>{initializeUserData();populateUserDetails();generatePreferencesSummary();generateInputIndex();runWorkflow();});
    </script>
</body>
</html>