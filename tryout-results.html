<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Summary with Animated Pattern Offset</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/tryout.css">
    <script src="https://cdn.jsdelivr.net/npm/clipper-lib@6.4.2/clipper.min.js"></script>
    <style>
        /* Inline essential styles */
        .generated-pattern {
            position: relative;
            width: 300px;
            height: 300px;
            border: 2px solid #e0e0e0;
            background-color: white;
        }
        #offset-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
    </style>
</head>
<body>
  <div class="container tryout-container">
    <main class="overview-content results-content">

      <!-- Title as a single-item system-list to get the blue box underline -->
      <ul class="system-list">
        <li>
          <a href="#" class="system-link">
            <span class="system-title">PROFILE SUMMARY</span>
          </a>
        </li>
      </ul>

      <section class="identification-section">
        <h2 class="section-title">USER IDENTIFICATION</h2>
        <div class="user-details" id="user-details"></div>
      </section>

      <section class="pattern-section">
        <div class="pattern-column">
          <div class="pattern-visual">
            <canvas id="offset-canvas" class="generated-pattern"></canvas>
          </div>
          <div class="input-index">
            <p><strong>Input Index:</strong></p>
            <p id="input-index-values"></p>
          </div>
        </div>
        <div class="preferences-summary">
          <h3 class="preferences-title">PREFERENCES</h3>
          <div class="preference-items" id="preference-items"></div>
        </div>
      </section>

      <nav class="action-links">
        <a href="#" class="action-link" onclick="printResults();return false;">PRINT OUTPUT</a>
        <a href="#" class="action-link" onclick="completeFlow();return false;">COMPLETE</a>
      </nav>
    </main>
  </div>

  <footer>
    <div class="footer-content">
      <div class="logo"><span class="icon">üåê</span><span class="logo-text">INTK72</span></div>
      <p class="footer-text">
        Developed during stable conditions, this system pre-defines meal timing, structure, and nutritional 
        balance to ensure continuity when access, availability, and predictability are compromised.
      </p>
    </div>
  </footer>
  
    <script>
        // Initialization
        function initializeUserData() {
            let userData = sessionStorage.getItem('intk72UserData');
            if (!userData) {
                userData = {
                    identification: {},
                    consumptionLimits: { dietary: [], allergies: [] },
                    answers: {}
                };
            } else {
                userData = JSON.parse(userData);
            }
            window.intk72UserData = userData;
            return userData;
        }

        // User Details
        function calculateAge(year, month, day) {
            if (!year || !month || !day) return null;
            const birthDate = new Date(year, month - 1, day);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
            return age;
        }
        function formatDate(day, month, year) {
            if (!day || !month || !year) return 'Not provided';
            return `${String(day).padStart(2,'0')}/${String(month).padStart(2,'0')}/${year}`;
        }
        function populateUserDetails() {
            const data = window.intk72UserData.identification;
            const age = calculateAge(data.birthYear, data.birthMonth, data.birthDay);
            const fullName = [data.firstName, data.lastName].filter(Boolean).join(' ');
            document.getElementById('user-details').innerHTML = `
                <div><strong>Full Name:</strong> ${fullName || 'Not provided'}</div>
                <div><strong>Age:</strong> ${age || 'Not provided'}</div>
                <div><strong>Date of Birth:</strong> ${formatDate(data.birthDay, data.birthMonth, data.birthYear)}</div>
                <div><strong>Gender:</strong> ${data.gender ? data.gender.charAt(0).toUpperCase()+data.gender.slice(1) : 'Not provided'}</div>
                <div><strong>Origin:</strong> ${data.origin || 'Not provided'}</div>
            `;
        }

        // Preferences
        function generatePreferencesSummary() {
            const ans = window.intk72UserData.answers;
            let lifestyle='Balanced', meal='Structured', flavor='Varied';
            if (ans.q1?.answer==='1') lifestyle='Healthy';
            if (ans.q1?.answer==='3') lifestyle='Quick';
            if (ans.q6?.answer==='1') meal='Regular';
            if (ans.q6?.answer==='4') meal='Random';
            if (ans.q9?.answer==='1') flavor='Homestyle';
            if (ans.q9?.answer==='2') flavor='Intense';
            let priority='Standard';
            if (window.intk72UserData.consumptionLimits.dietary.length||window.intk72UserData.consumptionLimits.allergies.length) priority='Specialized';
            document.getElementById('preference-items').innerHTML = `
                <div class="preference-item"><strong>Lifestyle:</strong> ${lifestyle}</div>
                <div class="preference-item"><strong>Meal:</strong> ${meal}</div>
                <div class="preference-item"><strong>Flavor:</strong> ${flavor}</div>
                <div class="preference-item"><strong>Priority Status:</strong> ${priority}</div>
            `;
        }

        // Input Index
        function generateInputIndex() {
            const ans = window.intk72UserData.answers;
            let idxStr='';
            for(let i=1;i<=9;i++) {
                const a = ans[`q${i}`];
                idxStr += `${i}.${a?.answer||0} `;
            }
            document.getElementById('input-index-values').textContent = idxStr.trim();
        }

        // Print & Complete
        function printResults(){ window.print(); }
        function completeFlow(){ sessionStorage.removeItem('intk72UserData'); window.location.href='index.html'; }

        // Pattern Offset Workflow
        const GRID=3,CELL=120,MM_TO_PX=3.78,OFFSET_MM=3,SF=200;
        const DELTA=Math.round(OFFSET_MM*MM_TO_PX*SF),CANVAS_MARGIN=OFFSET_MM*MM_TO_PX+10;
        const SAMPLE_STEP_PX=1,ARC_TOLERANCE=0.25,MITER_LIMIT=1000;
        let originalShapes=[],offsetPolys=[],outerPoly=[];
        const canvas=document.getElementById('offset-canvas');
        const ctx=canvas.getContext('2d');
        function resetCanvas(){const sz=GRID*CELL+CANVAS_MARGIN*2;canvas.width=sz;canvas.height=sz;ctx.setTransform(1,0,0,1,CANVAS_MARGIN,CANVAS_MARGIN);}
        function clearCanvas(){ctx.clearRect(-CANVAS_MARGIN,-CANVAS_MARGIN,canvas.width,canvas.height);}        
        function drawGrid(){ctx.save();ctx.strokeStyle='#ddd';ctx.lineWidth=1;for(let i=0;i<=GRID;i++){const p=i*CELL;ctx.beginPath();ctx.moveTo(p,0);ctx.lineTo(p,GRID*CELL);ctx.stroke();ctx.beginPath();ctx.moveTo(0,p);ctx.lineTo(GRID*CELL,p);ctx.stroke();}ctx.restore();}
        function drawPolys(polys,opts={}){const{s='#000',lw=1}=opts;ctx.beginPath();polys.forEach(poly=>{poly.forEach((pt,i)=>{const x=pt.X/SF,y=pt.Y/SF;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});ctx.closePath();});ctx.strokeStyle=opts.strokeStyle||s;ctx.lineWidth=opts.lineWidth||lw;ctx.stroke();}
        async function getPolygons(){const shapes=[];const ans=window.intk72UserData.answers||{};for(const[q,{shape}]of Object.entries(ans)){if(!shape)continue;const idx=parseInt(q.slice(1))-1,ox=(idx%GRID)*CELL,oy=Math.floor(idx/GRID)*CELL;const svg=await fetch(`assets/shapes/${shape}.svg`).then(r=>r.text());const doc=new DOMParser().parseFromString(svg,'image/svg+xml');const[vx,vy,vw,vh]=doc.querySelector('svg').getAttribute('viewBox').split(' ').map(Number);const sx=CELL/vw,sy=CELL/vh;doc.querySelectorAll('path').forEach(path=>{const pts=[];const len=path.getTotalLength();for(let d=0;d<=len;d+=SAMPLE_STEP_PX){const p=path.getPointAtLength(d);pts.push({X:Math.round(((p.x-vx)*sx+ox)*SF),Y:Math.round(((p.y-vy)*sy+oy)*SF)});}let curved=false;if(path.getPathData)path.getPathData().forEach(c=>{if(['C','Q','A'].includes(c.type))curved=true;});shapes.push({pts,isCurved:curved});});}return shapes;}
        function computeOffset(poly,curved){const co=new ClipperLib.ClipperOffset(ARC_TOLERANCE,MITER_LIMIT);co.AddPath(poly,curved?ClipperLib.JoinType.jtRound:ClipperLib.JoinType.jtMiter,ClipperLib.EndType.etClosedPolygon);const out=new ClipperLib.Paths();co.Execute(out,DELTA);return out;}
        function computeUnion(ps){const c=new ClipperLib.Clipper();ps.forEach(p=>c.AddPath(p,ClipperLib.PolyType.ptSubject,true));const o=new ClipperLib.Paths();c.Execute(ClipperLib.ClipType.ctUnion,o,ClipperLib.PolyFillType.pftNonZero,ClipperLib.PolyFillType.pftNonZero);return o;}
        function keepLargest(ps){if(!ps.length)return[];return[ps.reduce((b,c)=>Math.abs(ClipperLib.Clipper.Area(c))>Math.abs(ClipperLib.Clipper.Area(b))?c:b,ps[0])];}
        async function runWorkflow(){resetCanvas();clearCanvas();drawGrid();originalShapes=await getPolygons();drawPolys(originalShapes.map(s=>s.pts));await new Promise(r=>setTimeout(r,500));clearCanvas();drawPolys(originalShapes.map(s=>s.pts));offsetPolys=[];originalShapes.forEach(s=>offsetPolys.push(...computeOffset(s.pts,s.isCurved)));drawPolys(offsetPolys);await new Promise(r=>setTimeout(r,500));clearCanvas();drawPolys(offsetPolys,{strokeStyle:'#f00'});await new Promise(r=>setTimeout(r,500));outerPoly=keepLargest(computeUnion(offsetPolys));clearCanvas();drawPolys(outerPoly);await new Promise(r=>setTimeout(r,500));clearCanvas();drawPolys(outerPoly,{lineWidth:6});}
        document.addEventListener('DOMContentLoaded',()=>{initializeUserData();populateUserDetails();generatePreferencesSummary();generateInputIndex();runWorkflow();});
    </script>
</body>
</html>
